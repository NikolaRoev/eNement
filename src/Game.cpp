#include "Game.h"
#include "Drawable\\Drawable.h"
#include "GameStructures.h"


#include <algorithm>
#include <functional>
#include <vector>


#include <SFML/Audio.hpp>
#include <SFML/Graphics.hpp>
#include <SFML/System.hpp>
#include <SFML/Window.hpp>



//====================================================================================================================================
//====================================================================================================================================
//====================================================================================================================================
//====================================================================================================================================
//====================================================================================================================================

void en::Game::set_resources() {

	//====================================================================================================================================
	//====================================================================================================================================
	//====================================================================================================================================

	//====================================================================================================================================
	//Main Menu:

	core->manager->add_texture("assets/images/Main Menu/Main_Menu_Background.png", "Main Menu Background");
	core->manager->add_texture("assets/images/Main Menu/Start_Game_Button.png", "Start Game Button");
	core->manager->add_texture("assets/images/Main Menu/Start_Game_Button_HL.png", "Start Game Button HL");
	core->manager->add_texture("assets/images/Main Menu/Options_Button.png", "Options Button");
	core->manager->add_texture("assets/images/Main Menu/Options_Button_HL.png", "Options Button HL");
	core->manager->add_texture("assets/images/Main Menu/Quit_Button.png", "Quit Button");
	core->manager->add_texture("assets/images/Main Menu/Quit_Button_HL.png", "Quit Button HL");

	core->manager->add_sound_buffer("assets/sounds/TEST_CLICK.wav", "Test Sound");

	//====================================================================================================================================

	//====================================================================================================================================
	//====================================================================================================================================
	//====================================================================================================================================

	//====================================================================================================================================
	//Start Menu:



	//====================================================================================================================================
	//====================================================================================================================================
	//====================================================================================================================================

	//====================================================================================================================================
	//Options Menu:

	manager->add_texture("assets/images/Options Menu/Options_Menu_Background.png", "Options Menu Background");
	manager->add_texture("assets/images/Options Menu/Volume_Arrow_Left.png", "Volume Arrow Left");
	manager->add_texture("assets/images/Options Menu/Volume_Arrow_Left_HL.png", "Volume Arrow Left HL");
	manager->add_texture("assets/images/Options Menu/Volume_Arrow_Right.png", "Volume Arrow Right");
	manager->add_texture("assets/images/Options Menu/Volume_Arrow_Right_HL.png", "Volume Arrow Right HL");
	manager->add_texture("assets/images/Options Menu/Back_Button.png", "Back Button");
	manager->add_texture("assets/images/Options Menu/Back_Button_HL.png", "Back Button HL");

	manager->add_sound_buffer("assets/sounds/TEST_CLICK.wav", "Test Sound");

	manager->add_font("assets/fonts/TNR.ttf", "Test Font");

	//====================================================================================================================================

	//====================================================================================================================================
	//====================================================================================================================================
	//====================================================================================================================================

	//====================================================================================================================================
	//Chapter:

	

	//====================================================================================================================================

	//====================================================================================================================================
	//====================================================================================================================================
	//====================================================================================================================================

	//====================================================================================================================================
	//Spells:



	//====================================================================================================================================

	//====================================================================================================================================
	//====================================================================================================================================
	//====================================================================================================================================

	//====================================================================================================================================
	//Stats:



	//====================================================================================================================================

	//====================================================================================================================================
	//====================================================================================================================================
	//====================================================================================================================================

	//====================================================================================================================================
	//Fight:

	manager->add_texture("assets/images/Game/Fight_Background.png", "Fight Background");

	manager->add_texture_for_pixel_perfect("assets/images/Game/Player.png", "Player");
	manager->add_texture_for_pixel_perfect("assets/images/Game/Spell0.png", "Spell0");
	manager->add_texture_for_pixel_perfect("assets/images/Game/Spell1.png", "Spell1");

	manager->add_texture_for_pixel_perfect("assets/images/Game/Enemy0.png", "Enemy0");
	manager->add_texture_for_pixel_perfect("assets/images/Game/Enemy0_Attack.png", "Enemy0 Attack");

	//====================================================================================================================================

	//====================================================================================================================================
	//====================================================================================================================================
	//====================================================================================================================================

	//====================================================================================================================================
	//Pause:



	//====================================================================================================================================

	//====================================================================================================================================
	//====================================================================================================================================
	//====================================================================================================================================

	//====================================================================================================================================
	//Win:



	//====================================================================================================================================

	//====================================================================================================================================
	//====================================================================================================================================
	//====================================================================================================================================

	//====================================================================================================================================
	//Loss:



	//====================================================================================================================================

	//====================================================================================================================================
	//====================================================================================================================================
	//====================================================================================================================================

	//====================================================================================================================================
	//End:



	//====================================================================================================================================

	//====================================================================================================================================
	//====================================================================================================================================
	//====================================================================================================================================
}

void en::Game::set_drawables() {
	//====================================================================================================================================
	//====================================================================================================================================
	//====================================================================================================================================

	//====================================================================================================================================
	//Main Menu:

	

	//====================================================================================================================================

	//====================================================================================================================================
	//====================================================================================================================================
	//====================================================================================================================================

	//====================================================================================================================================
	//Start Menu:



	//====================================================================================================================================
	//====================================================================================================================================
	//====================================================================================================================================

	//====================================================================================================================================
	//Options Menu:

	

	//====================================================================================================================================

	//====================================================================================================================================
	//====================================================================================================================================
	//====================================================================================================================================

	//====================================================================================================================================
	//Chapter:



	//====================================================================================================================================

	//====================================================================================================================================
	//====================================================================================================================================
	//====================================================================================================================================

	//====================================================================================================================================
	//Spells:



	//====================================================================================================================================

	//====================================================================================================================================
	//====================================================================================================================================
	//====================================================================================================================================

	//====================================================================================================================================
	//Stats:



	//====================================================================================================================================

	//====================================================================================================================================
	//====================================================================================================================================
	//====================================================================================================================================

	//====================================================================================================================================
	//Fight:



	//====================================================================================================================================

	//====================================================================================================================================
	//====================================================================================================================================
	//====================================================================================================================================

	//====================================================================================================================================
	//Pause:



	//====================================================================================================================================

	//====================================================================================================================================
	//====================================================================================================================================
	//====================================================================================================================================

	//====================================================================================================================================
	//Win:



	//====================================================================================================================================

	//====================================================================================================================================
	//====================================================================================================================================
	//====================================================================================================================================

	//====================================================================================================================================
	//Loss:



	//====================================================================================================================================

	//====================================================================================================================================
	//====================================================================================================================================
	//====================================================================================================================================

	//====================================================================================================================================
	//End:



	//====================================================================================================================================

	//====================================================================================================================================
	//====================================================================================================================================
	//====================================================================================================================================
}

//====================================================================================================================================

void en::Game::load_save_file() {

}

void en::Game::save_save_file() {

}

//====================================================================================================================================

void en::Game::main_menu_loop() {
	std::vector<Drawable*> in_frame = {
		manager->get_drawable("Main Menu Background"),
		manager->get_drawable("Main Menu Load Game Button"),
		manager->get_drawable("Main Menu Options Button"),
		manager->get_drawable("Main Menu Quit Button")
	};

	
	while (application_state == MAIN_MENU) {

		for (const auto& each : in_frame) {
			each->draw();
		}

		core->window.display();
		core->window.pollEvent(core->event);

		if (core->event.type == sf::Event::Resized) {
			auto[resize_d_x, resize_d_y] = core->on_resize_event();
			
			auto temp_drawables = manager->get_all_drawables();
			for (const auto& each : temp_drawables) {
				each.second->resize(resize_d_x, resize_d_y);
			}
		}
		else if (core->event.type == sf::Event::Closed) {
			application_state = EXIT;
		}

	}

}

void en::Game::start_menu_loop() {
	//TO DO:
	if (player) {
		delete player->drawable;
		delete player;
	}

	
	application_state = GAME;
	player = new PlayerEntity;
	player->drawable = manager->get_drawable("Player");
}

void en::Game::options_menu_loop() {
	std::vector<Drawable*> in_frame = {
		manager->get_drawable("Options Menu Background"),
		manager->get_drawable("Volume Arrow Left"),
		manager->get_drawable("Volume Label"),
		manager->get_drawable("Volume Arrow Right"),
		manager->get_drawable("Back Button"),
	};


	while (application_state == OPTIONS_MENU) {

		for (const auto& each : in_frame) {
			each->draw();
		}

		core->window.display();
		core->window.pollEvent(core->event);

		if (core->event.type == sf::Event::Resized) {
			auto [resize_d_x, resize_d_y] = core->on_resize_event();

			auto temp_drawables = manager->get_all_drawables();
			for (const auto& each : temp_drawables) {
				each.second->resize(resize_d_x, resize_d_y);
			}
		}
		else if (core->event.type == sf::Event::Closed) {
			application_state = EXIT;
		}

	}
}

//====================================================================================================================================

void en::Game::game_loop() {

	while (application_state == GAME) {
		switch (game_state) {
			case CHAPTER:
				chapter_loop();
				break;
			case SPELLS:
				spells_loop();
				break;
			case STATS:
				stats_loop();
				break;
			case FIGHT:
				fight_loop();
				break;
			case WIN:
				win_loop();
				break;
			case LOSS:
				loss_loop();
				break;
			case END:
				end_loop();
				break;
		}
	}

}

void en::Game::chapter_loop() {

}

void en::Game::spells_loop() {

}

void en::Game::stats_loop() {

}

void en::Game::fight_loop() {
	std::vector<Drawable*> in_frame_static = {
		manager->get_drawable("Fight Background"),

	};

	if (current_enemy) {
		delete current_enemy->drawable;
		delete current_enemy;
	}

	//TO DO: Set the current enemy and his drawable pointer here.
	current_enemy = new EnemyEntity;

	std::vector<SpellEntity*> player_spells{SpellEntity::make_spell(player->first_spell), SpellEntity::make_spell(player->second_spell) };
	
	std::vector<Drawable*> enemy_spells;


	while (game_state == FIGHT && application_state == GAME) {
		core->time = core->clock.restart();
		//std::cout << TIME.asMicroseconds() << '\n';
		

		//Handle events. Generate player spells. Generate enemy spells.
		core->window.pollEvent(core->event);

		if (core->event.type == sf::Event::Resized) {
			auto [resize_d_x, resize_d_y] = core->on_resize_event();

			auto temp_drawables = manager->get_all_drawables();
			for (const auto& each : temp_drawables) {
				each.second->resize(resize_d_x, resize_d_y);
			}
		}
		else if (core->event.type == sf::Event::Closed) {
			application_state = EXIT;
		}

		//TO DO: Add the player spells generation from key press here and the current enemy generate spells function also.

		//------------------------------------------------------------------------------------------------------------------------------------


		//Draws.
		for (const auto& each : in_frame_static) {
			each->draw();
		}

		player->drawable->draw();

		//current_enemy->drawable->draw(core->window);

		//for (const auto& each : enemy_spells) {
			//each->draw(core->window);
		//}

		//for (const auto& each : player_spells) {
			//each->drawable->draw(core->window);
		//}


		core->window.display();
		//------------------------------------------------------------------------------------------------------------------------------------

		
		//Hit checks.
		//for (const auto& each : enemy_spells) {
			//if (each->hit_check(player->drawable->get_sprite())) {
				//Call a do damage function from current enemy.
			//}
		//}

		//for (const auto& each : player_spells) {
			//if (each->drawable->hit_check(current_enemy->drawable->get_sprite())) {
				//TO DO: Add a player spell entity do dmg function here.
			//}
		//}

		//------------------------------------------------------------------------------------------------------------------------------------


		//Health check, for player and enemy.

		//TO DO:

		//------------------------------------------------------------------------------------------------------------------------------------


		//Move spells and enemy.
		//for (const auto& each : enemy_spells) {
			//each->move();
		//}

		//for (const auto& each : player_spells) {
			//each->drawable->move();
		//}

		//current_enemy->drawable->move();

		//------------------------------------------------------------------------------------------------------------------------------------


		//Clear out of bounds enemy spells.
		std::for_each(std::begin(enemy_spells), std::end(enemy_spells), DrawableDeleter());
		std::vector<Drawable*>::iterator new_end = std::remove(std::begin(enemy_spells), std::end(enemy_spells), static_cast<Drawable*>(nullptr));
		enemy_spells.erase(new_end, std::end(enemy_spells));
		//------------------------------------------------------------------------------------------------------------------------------------
	}

}

void en::Game::pause_loop() {

}

void en::Game::win_loop() {

}

void en::Game::loss_loop() {

}

void en::Game::end_loop() {

}

//====================================================================================================================================

void en::Game::main_loop() {
	core = new Core(1920.0, 1080.0);
	core->load_settings();
	core->set_window();


	set_resources();
	set_drawables();


	while (application_state != EXIT) {
		switch (application_state) {
			case MAIN_MENU:
				main_menu_loop();
				break;
			case START_MENU:
				start_menu_loop();
				break;
			case OPTIONS_MENU:
				options_menu_loop();
				break;
			case GAME:
				game_loop();
				break;
		}
	}

	save_save_file();
	core->save_settings();
	delete core;
}

//====================================================================================================================================
//====================================================================================================================================
//====================================================================================================================================
//====================================================================================================================================
//====================================================================================================================================